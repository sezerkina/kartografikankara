
<!DOCTYPE html>

<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
\1

<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">

// --- Robust removal of Leaflet credits & scale, and dynamic 1: scale display ---
(function(){
  function ensureHidden() {
    // Remove any attribution or scale controls in DOM
    document.querySelectorAll('.leaflet-control-attribution, .leaflet-control-scale').forEach(el => { try{ el.remove(); }catch(e){} });
    // Force css as fallback
    const s = document.createElement('style');
    s.id = 'force-hide-leaflet-credits';
    s.innerHTML = '.leaflet-control-attribution, .leaflet-control-scale{display:none !important; visibility:hidden !important; height:0 !important; margin:0 !important; padding:0 !important;}';
    if(!document.getElementById('force-hide-leaflet-credits')) document.head.appendChild(s);
  }

  // Run a few times to catch controls re-added by Leaflet
  ensureHidden();
  setTimeout(ensureHidden, 250);
  setTimeout(ensureHidden, 800);
  map.on && map.on('layeradd', ensureHidden);

  // Create or update custom scale element
  let scaleDiv = document.querySelector('.custom-scale');
  if(!scaleDiv){
    scaleDiv = L.DomUtil.create('div', 'custom-scale');
    scaleDiv.style.position = 'absolute';
    scaleDiv.style.bottom = '8px';
    scaleDiv.style.right = '75px';
    scaleDiv.style.background = 'rgba(255,255,255,0.95)';
    scaleDiv.style.padding = '4px 8px';
    scaleDiv.style.borderRadius = '4px';
    scaleDiv.style.fontSize = '11px';
    scaleDiv.style.fontWeight = '600';
    scaleDiv.style.boxShadow = '0 1px 2px rgba(0,0,0,0.08)';
    scaleDiv.style.zIndex = '1000';
    map.getContainer().appendChild(scaleDiv);
  }

  function updateScale() {
    const lat = map.getCenter().lat * Math.PI / 180;
    // meters per pixel at given zoom
    const metersPerPixel = 40075016.686 * Math.cos(lat) / Math.pow(2, map.getZoom() + 8);
    // convert meters per pixel to map scale at 96 DPI (0.000264583 meters per pixel)
    const scale = Math.round(1 / (metersPerPixel / 0.000264583));
    scaleDiv.textContent = '1:' + scale.toLocaleString('tr-TR');
  }

  if(map && map.on){
    map.on('zoomend moveend viewreset', updateScale);
    updateScale();
  } else {
    setTimeout(()=>{ if(map && map.on){ map.on('zoomend moveend viewreset', updateScale); updateScale(); } }, 500);
  }

  // Also nudge zoom control position if needed
  function nudgeZoom() {
    const z = document.querySelector('.leaflet-control-zoom');
    if(z){ z.style.right = '10px'; z.style.bottom = '30px'; z.style.transition = 'right 0.2s, bottom 0.2s'; }
  }
  nudgeZoom();
  setTimeout(nudgeZoom, 500);
})();
</script>
<!-- Yerel -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif Font TanÄ±mlarÄ± -->
<style>
html,body{
  height:100%;
  margin:0;
  font-family:'-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif', sans-serif !important;
  background:#f7f9fb;
  overflow:hidden;
}

/* Sidebar */
#sidebar{
  position:absolute;
  left:0;top:0;
  width:340px;height:100%;
  background:#fff;
  border-right:1px solid #e6eef6;
  box-shadow:2px 0 6px rgba(0,0,0,0.06);
  padding:18px;
  box-sizing:border-box;
  overflow:auto;
  transition:transform .35s ease;
  z-index:1200;
}
#sidebar.closed{transform:translateX(-100%);}
#toggle-btn{
  position:absolute;
  top:20px;left:340px;
  width:28px;height:48px;
  background:#fff;border:1px solid #d0d7df;border-left:none;
  border-radius:0 6px 6px 0;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;z-index:2000;
  box-shadow:0 1px 3px rgba(0,0,0,0.15);
  transition:background 0.2s ease, left .35s ease;
}
#toggle-btn:hover{background:#f3f4f6;}
#toggle-btn span{font-size:14pt;color:#333;user-select:none;}
#sidebar h1{font-weight:700;font-size:12pt;margin:4px 0 8px;}
#sidebar .description{font-weight:400;font-style:italic;font-size:8pt;color:#445;line-height:1.2;margin-bottom:12px;}
#search{width:100%;padding:6px 8px;font-size:8pt;font-style:italic;border:1px solid #d0d7df;border-radius:6px;margin-bottom:12px;box-sizing:border-box;}
.film{margin-bottom:10px;border-bottom:1px solid #f0f4f8;padding-bottom:8px;}
.film-title{cursor:pointer;font-weight:500;font-size:11pt;color:#333;margin-bottom:6px;}
.mekan-list{list-style:disc;margin:0 0 0 18px;padding:0;display:none;}
.mekan-list li{font-weight:400;font-size:9pt;margin-bottom:6px;cursor:pointer;color:#333;}
.mekan-list li:hover{text-decoration:underline;}
#map{position:absolute;left:0;top:0;right:0;bottom:0;z-index:1;}
.leaflet-control-zoom{position:absolute !important;bottom:20px;right:20px;transform:scale(0.8);border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,0.1);}
.leaflet-popup-content img{max-width:260px;height:auto;border-radius:6px;margin-top:6px;display:block;}
.leaflet-popup-content-wrapper {width:300px !important;max-width:300px !important;}
.leaflet-popup-content { font-family: '-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif', sans-serif !important; font-weight: 400; }
</style>
<style>body, html, .leaflet-popup-content { font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important; }</style>
<style>
.leaflet-popup-content-wrapper,
.leaflet-popup-content,
.leaflet-popup-tip,
.leaflet-container,
.leaflet-popup {
  font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
  -webkit-font-smoothing: antialiased !important;
  -moz-osx-font-smoothing: grayscale !important;
}
</style>
<style>
/* Force-hide Leaflet attribution and scale controls (important because some versions re-insert them) */
.leaflet-control-attribution, .leaflet-control-scale { display: none !important; visibility: hidden !important; height: 0 !important; margin: 0 !important; padding: 0 !important; }
.leaflet-control-zoom { right: 10px !important; bottom: 30px !important; }



</style></head>
<body>
<aside id="sidebar">
<h1>Ankaraâ€™nÄ±n Sinematik KartografyasÄ±</h1>
<div class="description">
    Bu Ã§alÄ±ÅŸma Ankara Ãœniversitesi Sosyal Bilimler EnstitÃ¼sÃ¼ Radyo Televizyon ve Sinema Anabilim DalÄ±'nda 
    Prof. Dr. S. Ruken Ã–ztÃ¼rk danÄ±ÅŸmanlÄ±ÄŸÄ±nda Sezer Ahmet KÄ±na tarafÄ±ndan yÃ¼rÃ¼tÃ¼len 
    <i>"Sinemada Kentin DÃ¶nÃ¼ÅŸÃ¼mÃ¼nÃ¼ Seyretmek: Ankara Ã–rneÄŸi"</i> baÅŸlÄ±klÄ± doktora tezi kapsamÄ±nda hazÄ±rlanmÄ±ÅŸtÄ±r.
  
<div id="tab-menu" style="display:flex;gap:8px;margin-bottom:12px;"><button class="tab-btn active" data-tab="filmler" style="flex:1;padding:6px 4px;border:1px solid #ccc;border-radius:6px;background:#e8ecf3;font-weight:600;cursor:pointer;">Filmler ve MekÃ¢nlar</button><button class="tab-btn" data-tab="yogunluk" style="flex:1;padding:6px 4px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;">MekÃ¢nsal DaÄŸÄ±lÄ±m ve YoÄŸunluk</button><button class="tab-btn" data-tab="duygu" style="flex:1;padding:6px 4px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;">Duygu HaritalarÄ±</button></div>
<div id="tab1" class="tab-content active"></div>
<div id="tab2" class="tab-content"></div>
<div id="tab3" class="tab-content"></div>
</div>
<input aria-label="Haritada ara" id="search" placeholder="Haritada ara"/>
<div id="film-list"></div>
</aside>
<div id="toggle-btn"><span>â—‚</span></div>
<div id="map"></div>
<script>
// folder temizleyici
function cleanFolderName(folder){
  if(!folder) return "";
  return folder.replace(/[\/|]+/g, '').trim();
}

// Harita
const map = L.map('map', {zoomControl:true}).setView([39.93,32.85],11);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap contributors, &copy; Carto',
  maxZoom: 22, attributionControl: false
}).addTo(map);
map.zoomControl.setPosition('bottomright');
// Ã–lÃ§ek ekle
L.control.scale({position:'bottomright', metric:true, imperial:false}).addTo(map);


let films = {};
let featureToLayer = new Map();
let allLayers = L.layerGroup().addTo(map);

// GeoJSON yÃ¼kle
fetch('kmzs.geojson')
.then(r=>r.json())
.then(data=>{
  data.features.forEach(f=>{
    const folder = cleanFolderName(f.properties?.folder);
    const film = folder || "Bilinmeyen Film";
    const name = f.properties?.name || "(AdsÄ±z MekÃ¢n)";
    if(!films[film]) films[film]=[];
    films[film].push(f);

    const geom = f.geometry;
    if(!geom) return;

    let layer = null;
    const styleProps = f.properties?.style || {};
    const color = styleProps.fillColor || '#e63946';

    // Handle different geometry types robustly
    if(geom.type === 'Point'){
      const coords = [geom.coordinates[1], geom.coordinates[0]];
      const radius = styleProps.radius || 6;
      layer = L.circleMarker(coords, {
        radius,
        color,
        fillColor: styleProps.fillColor || color,
        fillOpacity: ('fillOpacity' in styleProps) ? styleProps.fillOpacity : 1
      });
    } else if(geom.type === 'MultiPoint'){
      const coords = geom.coordinates.map(c => [c[1], c[0]]);
      const group = L.featureGroup(coords.map(c => L.circleMarker(c, {radius: styleProps.radius||6, color, fillColor: styleProps.fillColor||color, fillOpacity: ('fillOpacity' in styleProps)? styleProps.fillOpacity:1})));
      layer = group;
    } else if(geom.type === 'LineString' || geom.type === 'MultiLineString'){
      const coords = (geom.type === 'LineString') ? geom.coordinates.map(c => [c[1], c[0]]) : geom.coordinates.map(line => line.map(c => [c[1], c[0]]));
      layer = (geom.type === 'LineString') ? L.polyline(coords, {color: color, weight: 3, opacity: 0.9}) : L.featureGroup(coords.map(line => L.polyline(line, {color: color, weight:3, opacity:0.9})));
    } else if(geom.type === 'Polygon' || geom.type === 'MultiPolygon'){
      const coords = (geom.type === 'Polygon') ? geom.coordinates.map(ring => ring.map(c => [c[1], c[0]])) : geom.coordinates.map(poly => poly.map(ring => ring.map(c => [c[1], c[0]])));
      layer = (geom.type === 'Polygon') ? L.polygon(coords, {color: color, weight:2, fillColor: color, fillOpacity:0.3}) : L.featureGroup(coords.map(poly => L.polygon(poly, {color: color, weight:2, fillColor: color, fillOpacity:0.3})));
    }

    if(layer){
      const props = f.properties || {};
      let desc = props.description || '';
      const imgMatches = (desc.match(/<img[^>]*>/gi) || []);
      desc = desc.replace(/<img[^>]*>/gi, '').trim();
      if(props.image){ imgMatches.push(`<img src="${props.image}" alt="">`); }

      let popup = `<div style="font-family:-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important;">`;
      popup += `<div style="font-weight:700;font-size:11pt;margin-bottom:4px;">${name}</div>`;
      popup += `<div style="font-weight:500;font-size:10pt;margin-bottom:6px;">${folder}</div>`;
      if(desc){ popup += `<div style="font-weight:400;font-size:9pt;margin-bottom:8px;">${desc}</div>`; }
      if(imgMatches.length){ popup += imgMatches.join(''); }
      popup += `</div>`;

      // Bind popup to each layer (handle featureGroup or layerGroup)
      if(layer.getLayers && typeof layer.getLayers === 'function'){
        layer.getLayers().forEach(ch => { if(ch.bindPopup) ch.bindPopup(popup); ch.feature = f; allLayers.addLayer(ch); featureToLayer.set(f, ch); });
      } else {
        if(layer.bindPopup) layer.bindPopup(popup);
        layer.feature = f;
        allLayers.addLayer(layer);
        featureToLayer.set(f, layer);
      }
    }
  });

  try{
    const b=allLayers.getBounds();
    if(b && b.isValid && b.isValid()) map.fitBounds(b.pad(0.08));
  }catch(e){ map.setView([39.93,32.85],11); }

  const filmList = document.getElementById('film-list');
  Object.keys(films)
  .sort((a,b)=>{
    const ya=parseInt((a.match(/\d{4}/)||[0])[0]);
    const yb=parseInt((b.match(/\d{4}/)||[0])[0]);
    return (ya||9999)-(yb||9999);
  })
  .forEach(film=>{
    const div=document.createElement('div');
    div.className='film';
    const title=document.createElement('div');
    title.className='film-title';
    title.textContent=film;
    const ul=document.createElement('ul');
    ul.className='mekan-list';

    films[film].forEach(feat=>{
      const li=document.createElement('li');
      li.textContent=feat.properties.name||'(AdsÄ±z Mekan)';
      li.onclick=(e)=>{
        e.stopPropagation();
        const layer=featureToLayer.get(feat);
        if(!layer) return;
        const g=feat.geometry;
        if(g.type==='Point'){ map.setView([g.coordinates[1],g.coordinates[0]],16); }
        layer.openPopup();
      };
      ul.appendChild(li);
    });

    title.onclick=()=>{
      ul.style.display=(ul.style.display==='none'||ul.style.display==='')?'block':'none';
    };
    div.appendChild(title);
    div.appendChild(ul);
    filmList.appendChild(div);
  });

  document.getElementById('search').addEventListener('input',(e)=>{
    const q=e.target.value.trim().toLowerCase();
    document.querySelectorAll('.film').forEach(div=>{
      const title=div.querySelector('.film-title').textContent.toLowerCase();
      const lis=Array.from(div.querySelectorAll('li')).map(li=>li.textContent.toLowerCase());
      const match=title.includes(q)||lis.some(t=>t.includes(q));
      div.style.display=match?'block':'none';
      if(q){
        div.querySelectorAll('li').forEach(li=>{
          const text=li.textContent;
          const re=new RegExp(q,'gi');
          li.innerHTML=text.replace(re, m=>'<mark>'+m+'</mark>');
        });
      } else {
        div.querySelectorAll('li').forEach(li=> li.innerHTML=li.textContent);
      }
    });
  });

  const sidebar=document.getElementById('sidebar');
  const toggle=document.getElementById('toggle-btn');
  const arrow=toggle.querySelector('span');
  toggle.addEventListener('click',()=>{
    sidebar.classList.toggle('closed');
    if(sidebar.classList.contains('closed')){
      toggle.style.left='0';
      arrow.textContent='â–¸';
    } else {
      toggle.style.left='340px';
      arrow.textContent='â—‚';
    }
    map.invalidateSize();
  });
})
.catch(err=>{
  console.error('GeoJSON load error', err);
  alert('GeoJSON yÃ¼klenemedi. Konsolu kontrol et.');
});
</script>

<script>
// Sekme kontrolÃ¼
document.addEventListener('click', e => {
  if(e.target.classList.contains('tab-button')){
    document.querySelectorAll('.tab-button').forEach(btn=>btn.classList.remove('active'));
    e.target.classList.add('active');
    const tab = e.target.dataset.tab;
    document.querySelectorAll('.tab-content').forEach(div=>{
      div.classList.toggle('active', div.id === tab);
    });
  }
});
</script>


<script>
// --- TÃ¼mÃ¼nÃ¼ GÃ¶rÃ¼ntÃ¼le ve filtreleme (v3) ---
function showAllLayers(){
  allLayers.eachLayer(l => map.addLayer(l));
  try{
    const b=allLayers.getBounds();
    if(b && b.isValid && b.isValid()) map.fitBounds(b.pad(0.08));
  }catch(e){ map.setView([39.93,32.85],11); }
}

function showOnlyFilm(filmName){
  allLayers.eachLayer(l => map.removeLayer(l));
  allLayers.eachLayer(l => {
    const feat = l.feature;
    const folder = (feat.properties?.folder || '').replace(/[\\/|]+/g, '').trim();
    if(folder === filmName) map.addLayer(l);
  });
  try{
    const visibleLayers = [];
    allLayers.eachLayer(l => { if(map.hasLayer(l)) visibleLayers.push(l); });
    if(visibleLayers.length){
      const bounds = L.featureGroup(visibleLayers).getBounds();
      if(bounds && bounds.isValid && bounds.isValid()) map.fitBounds(bounds.pad(0.08));
    }
  }catch(e){}
}

// Film listesi oluÅŸturulduktan sonra ekle
document.addEventListener('DOMContentLoaded', () => {
  const filmList = document.getElementById('film-list');
  if (!filmList) return;

  // TÃ¼mÃ¼nÃ¼ GÃ¶rÃ¼ntÃ¼le seÃ§eneÄŸini en baÅŸa ekle
  const allDiv = document.createElement('div');
  allDiv.className = 'film';
  const allTitle = document.createElement('div');
  allTitle.className = 'film-title';
  allTitle.textContent = 'ðŸŽ¬ TÃ¼mÃ¼nÃ¼ GÃ¶rÃ¼ntÃ¼le';
  allTitle.onclick = () => showAllLayers();
  allDiv.appendChild(allTitle);
  filmList.prepend(allDiv);

  // Film baÅŸlÄ±klarÄ±na filtreleme ekle
  filmList.addEventListener('click', e => {
    if (e.target.classList.contains('film-title')) {
      const name = e.target.textContent.trim();
      if (name === 'ðŸŽ¬ TÃ¼mÃ¼nÃ¼ GÃ¶rÃ¼ntÃ¼le') {
        showAllLayers();
      } else {
        showOnlyFilm(name);
      }
    }
  });
});
</script>

</body>
</html>
