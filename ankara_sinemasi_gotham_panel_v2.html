<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ankara SinemasÄ± HaritasÄ±</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
@font-face {font-family: 'Gotham'; src: url('https://raw.githubusercontent.com/sezerkina/deneme2/main/fonts/Gotham%20Book.otf') format('opentype'); font-weight:400; font-style:normal;}
@font-face {font-family: 'Gotham'; src: url('https://raw.githubusercontent.com/sezerkina/deneme2/main/fonts/Gotham%20Book%20Italic.ttf') format('truetype'); font-weight:400; font-style:italic;}
@font-face {font-family: 'Gotham'; src: url('https://raw.githubusercontent.com/sezerkina/deneme2/main/fonts/Gotham%20Medium.otf') format('opentype'); font-weight:500; font-style:normal;}
@font-face {font-family: 'Gotham'; src: url('https://raw.githubusercontent.com/sezerkina/deneme2/main/fonts/Gotham%20Medium%20Italic.ttf') format('truetype'); font-weight:500; font-style:italic;}
@font-face {font-family: 'Gotham'; src: url('https://raw.githubusercontent.com/sezerkina/deneme2/main/fonts/Gotham%20Bold.otf') format('opentype'); font-weight:700; font-style:normal;}

html,body{height:100%;margin:0;font-family:Gotham, "Helvetica Neue", Arial, sans-serif;background:#f7f9fb;overflow:hidden;}

/* -------- SIDEBAR -------- */
#sidebar{
  position:absolute;
  left:0;top:0;
  width:340px;height:100%;
  background:#fff;
  border-right:1px solid #e6eef6;
  box-shadow:2px 0 6px rgba(0,0,0,0.06);
  padding:18px;
  box-sizing:border-box;
  overflow:auto;
  transition:transform .35s ease;
  z-index:1200;
}
#sidebar.closed{
  transform:translateX(-100%);
}

/* Toggle Button (kendi konumunu JS ile ayarlÄ±yoruz) */
#toggle-btn{
  position:absolute;
  top:20px;
  left:340px;
  width:28px;
  height:48px;
  background:#fff;
  border:1px solid #d0d7df;
  border-left:none;
  border-radius:0 6px 6px 0;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:2000;
  box-shadow:0 1px 3px rgba(0,0,0,0.15);
  transition:background 0.2s ease, left .35s ease;
}
#toggle-btn:hover{background:#f3f4f6;}
#toggle-btn span{font-size:14pt;color:#0f172a;user-select:none;}

/* -------- LÄ°STELER -------- */
#sidebar h1{font-weight:700;font-size:12pt;margin:4px 0 8px;}
#sidebar .description{font-weight:400;font-style:italic;font-size:8pt;color:#445;line-height:1.2;margin-bottom:12px;}
#search{width:100%;padding:6px 8px;font-size:8pt;font-style:italic;border:1px solid #d0d7df;border-radius:6px;margin-bottom:12px;box-sizing:border-box;}

.film{margin-bottom:10px;border-bottom:1px solid #f0f4f8;padding-bottom:8px;}
.film-title{cursor:pointer;font-weight:500;font-size:11pt;color:#0f172a;margin-bottom:6px;}
.mekan-list{list-style:disc;margin:0 0 0 18px;padding:0;display:none;}
.mekan-list li{font-weight:400;font-size:9pt;margin-bottom:6px;cursor:pointer;color:#0f172a;}
.mekan-list li:hover{text-decoration:underline;}

/* -------- HARÄ°TA -------- */
#map{position:absolute;left:0;top:0;right:0;bottom:0;z-index:1;}
.leaflet-control-zoom{position:absolute !important;bottom:20px;right:20px;}

/* DivIcon kÃ¼Ã§Ã¼k daire stili */
.marker-div {
  width: 28px;
  height: 28px;
  border-radius: 14px;
  border: 2px solid #fff;
  box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.marker-div.small { width: 18px; height:18px; border-radius:9px; }
.marker-div.large { width: 40px; height:40px; border-radius:20px; }

/* popup images */
.leaflet-popup-content img{max-width:260px;height:auto;border-radius:6px;margin-top:6px;display:block;}
</style>
</head>

<body>
<aside id="sidebar">
  <h1>Ankara SinemasÄ± HaritasÄ±: Filmler ve MekÃ¢nlar ðŸŽ¬</h1>
  <div class="description">
    Bu Ã§alÄ±ÅŸma Ankara Ãœniversitesi Sosyal Bilimler EnstitÃ¼sÃ¼ Radyo Televizyon ve Sinema Anabilim DalÄ±'nda 
    Prof. Dr. S. Ruken Ã–ztÃ¼rk danÄ±ÅŸmanlÄ±ÄŸÄ±nda Sezer Ahmet KÄ±na tarafÄ±ndan yÃ¼rÃ¼tÃ¼len 
    <i>"Sinemada Kentin DÃ¶nÃ¼ÅŸÃ¼mÃ¼nÃ¼ Seyretmek: Ankara Ã–rneÄŸi"</i> baÅŸlÄ±klÄ± doktora tezi kapsamÄ±nda hazÄ±rlanmÄ±ÅŸtÄ±r.
  </div>
  <input id="search" placeholder="Haritada ara" aria-label="Haritada ara">
  <div id="film-list"></div>
</aside>

<div id="toggle-btn"><span>â—‚</span></div>
<div id="map"></div>

<script>
// ---- YardÄ±mcÄ± fonksiyonlar: renk ve ikon Ã§Ã¶zÃ¼mleyiciler ----

// KML renk (aabbggrr) -> #rrggbb
function kmlColorToHex(kml) {
  if(!kml) return null;
  // clean non-hex
  const s = String(kml).replace(/[^A-Fa-f0-9]/g,'');
  if(s.length === 8) {
    // aabbggrr -> rrggbb
    const a = s.slice(0,2), bb = s.slice(2,4), gg = s.slice(4,6), rr = s.slice(6,8);
    return '#' + rr + gg + bb;
  }
  if(s.length === 6) { return '#' + s; }
  return null;
}

// hex normalization
function normalizeHex(h) {
  if(!h) return null;
  const m = String(h).match(/#?[A-Fa-f0-9]{6}/);
  if(m) return (m[0].startsWith('#')?m[0]:'#'+m[0]);
  return null;
}

// create a DivIcon colored circle (keeps sharp on scaling)
function createColoredDivIcon(color, size=28) {
  const cls = 'marker-div' + (size<=18? ' small' : (size>=36? ' large':''));
  const style = `background:${color};width:${size}px;height:${size}px;border-radius:${Math.floor(size/2)}px;display:block;`;
  const html = `<div class="${cls}" style="${style}"></div>`;
  return L.divIcon({html: html, className: 'custom-div-icon', iconSize: [size, size], iconAnchor: [Math.floor(size/2), Math.floor(size)]});
}

// pick color from various property shapes
function pickColorFromProps(props) {
  if(!props) return null;
  // 1) styleUrl like "#line-FF5252-1388" or "#FF5252"
  if(props.styleUrl) {
    const m = String(props.styleUrl).match(/#[0-9A-Fa-f]{6}/);
    if(m) return m[0];
  }
  // 2) polyStyle or lineStyle color
  if(props.lineStyle && props.lineStyle.color) {
    const c = normalizeHex(props.lineStyle.color);
    if(c) return c;
  }
  if(props.polyStyle && props.polyStyle.color) {
    const c = kmlColorToHex(props.polyStyle.color) || normalizeHex(props.polyStyle.color);
    if(c) return c;
  }
  // 3) KML color field (sometimes props.color or props.kml_color)
  if(props.color) {
    const c = kmlColorToHex(props.color) || normalizeHex(props.color);
    if(c) return c;
  }
  if(props.kml_color) {
    const c = kmlColorToHex(props.kml_color) || normalizeHex(props.kml_color);
    if(c) return c;
  }
  // 4) marker-color common geojson prop
  if(props['marker-color']) {
    const c = normalizeHex(props['marker-color']);
    if(c) return c;
  }
  // default
  return '#2563eb';
}

// create Leaflet layer for a feature with style inference
function createLayerForFeature(f) {
  const geom = f.geometry;
  const props = f.properties || {};
  if(!geom) return null;

  // helper to create popup content
  const film = (props.folder ? String(props.folder).split('/')[0].replace(/[|]+/g,'').trim() : 'Bilinmeyen Film');
  const name = props.name || props.title || '(AdsÄ±z MekÃ¢n)';
  let popup = `<div style="font-family:Gotham, Arial, sans-serif;">`;
  popup += `<div style="font-weight:700;margin-bottom:4px;">${escapeHtml(film)}</div>`;
  popup += `<div style="font-weight:600;margin-bottom:6px;">${escapeHtml(name)}</div>`;
  if(props.description) popup += `<div>${props.description}</div>`;
  popup += `</div>`;

  // POINT
  if(geom.type === 'Point') {
    const coords = [geom.coordinates[1], geom.coordinates[0]];

    // 1) direct icon href/url (data: or remote)
    const iconHref = (props.icon && (props.icon.href || props.icon.url)) || props['icon.href'] || props.iconUrl || props.icon_url || null;
    if(iconHref) {
      // detect scale
      const scale = (props.icon && props.icon.scale) || props['icon.scale'] || props.iconScale || 1;
      // set reasonable icon size
      const size = Math.max(12, Math.min(64, Math.round(32 * Number(scale))));
      const icon = L.icon({iconUrl: iconHref, iconSize: [size, size], iconAnchor: [Math.floor(size/2), size]});
      const marker = L.marker(coords, {icon});
      marker.bindPopup(popup);
      return marker;
    }

    // 2) color info or styleUrl -> use colored DivIcon or circleMarker
    const color = pickColorFromProps(props) || '#2563eb';

    // If prop explicitly requests circleMarker style (fill/stroke)
    if(props.marker === 'circle' || props.useCircle || props.circle === true) {
      const radius = props.radius || (props.scaledRadius ? Math.max(4, Math.round(6 * (props.scaledRadius||1))) : 6);
      const circle = L.circleMarker(coords, {
        radius: radius,
        color: props.strokeColor || color,
        fillColor: props.fillColor || color,
        fillOpacity: props.fillOpacity ?? 1,
        weight: props.strokeWidth ?? 1
      });
      circle.bindPopup(popup);
      return circle;
    }

    // Otherwise create DivIcon marker that can mimic colored icon (keeps crisp)
    const scaleVal = (props.icon && props.icon.scale) || props['icon.scale'] || props.scale || 1;
    const size = Math.max(14, Math.min(48, Math.round(24 * Number(scaleVal)));
    // but DivIcon fallback:
    const divIcon = createColoredDivIcon(color, size);
    const marker = L.marker(coords, {icon: divIcon});
    marker.bindPopup(popup);
    return marker;
  }

  // LINESTRING
  if(geom.type === 'LineString' || geom.type === 'MultiLineString') {
    const coords = (geom.type === 'LineString') ? geom.coordinates.map(c=>[c[1], c[0]]) : geom.coordinates.flat().map(c=>[c[1], c[0]]);
    const style = props.lineStyle || {};
    const color = pickColorFromProps(props) || style.color || '#ff5252';
    const weight = style.width || 3;
    const opacity = style.opacity ?? 0.9;
    const poly = L.polyline(coords, {color: color, weight: weight, opacity: opacity});
    poly.bindPopup(popup);
    return poly;
  }

  // POLYGON
  if(geom.type === 'Polygon' || geom.type === 'MultiPolygon') {
    const coords = (geom.type === 'Polygon') ? geom.coordinates[0].map(c=>[c[1],c[0]]) : geom.coordinates.flat(2).map(c=>[c[1],c[0]]);
    const polyStyle = props.polyStyle || {};
    const fillColor = pickColorFromProps(props) || polyStyle.fillColor || '#fde68a';
    const strokeColor = polyStyle.strokeColor || fillColor;
    const weight = polyStyle.weight || 2;
    const fillOpacity = polyStyle.fillOpacity ?? 0.4;
    const polygon = L.polygon(coords, {color: strokeColor, weight: weight, fillColor: fillColor, fillOpacity: fillOpacity});
    polygon.bindPopup(popup);
    return polygon;
  }

  return null;
}

// small helper to escape text parts
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

// ---- Harita baÅŸlangÄ±cÄ± ----
const map = L.map('map', {zoomControl:true}).setView([39.93,32.85],11);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap contributors, &copy; Carto',
  maxZoom: 22
}).addTo(map);
map.zoomControl.setPosition('bottomright');

let films = {};
let featureToLayer = new Map();
let allLayers = L.layerGroup().addTo(map);

// Pozisyon toggle butonunu panel kenarÄ±na hizala (baÅŸlangÄ±Ã§)
const toggleBtn = document.getElementById('toggle-btn');
function updateTogglePosition(isClosed) {
  if(isClosed) {
    toggleBtn.style.left = '0';
  } else {
    toggleBtn.style.left = '340px';
  }
}
updateTogglePosition(false);

// GeoJSON yÃ¼kle ve stilleri uygula
fetch('merged_from_kmz.geojson').then(r=>r.json()).then(data=>{
  data.features.forEach(f=>{
    const folder = f.properties?.folder;
    const film = folder ? String(folder).split('/')[0].replace(/[|]+/g,'').trim() : 'Bilinmeyen Film';
    const name = f.properties?.name || f.properties?.title || '(AdsÄ±z MekÃ¢n)';
    if(!films[film]) films[film] = [];
    films[film].push(f);

    const layer = createLayerForFeature(f);
    if(layer) {
      allLayers.addLayer(layer);
      featureToLayer.set(f, layer);
    }
  });

  // fit map
  try {
    const b = allLayers.getBounds();
    if(b && b.isValid && b.isValid()) map.fitBounds(b.pad(0.08));
  } catch(e) { map.setView([39.93,32.85],11); }

  // build sidebar list
  const filmList = document.getElementById('film-list');
  Object.keys(films).sort().forEach(film=>{
    const div = document.createElement('div'); div.className='film';
    const title = document.createElement('div'); title.className='film-title'; title.textContent = film;
    const ul = document.createElement('ul'); ul.className='mekan-list';
    films[film].forEach(feat=>{
      const li = document.createElement('li');
      const pname = feat.properties?.name || feat.properties?.title || '(AdsÄ±z Mekan)';
      li.textContent = pname;
      li.onclick = (e) => {
        e.stopPropagation();
        const layer = featureToLayer.get(feat);
        if(!layer) return;
        const g = feat.geometry;
        if(g.type === 'Point') { map.setView([g.coordinates[1], g.coordinates[0]], 16); }
        else if(g.type === 'LineString') { map.fitBounds(L.polyline(g.coordinates.map(c=>[c[1],c[0]])).getBounds().pad(0.2)); }
        else if(g.type === 'Polygon') { map.fitBounds(L.polygon(g.coordinates[0].map(c=>[c[1],c[0]])).getBounds().pad(0.2)); }
        layer.openPopup();
      };
      ul.appendChild(li);
    });
    title.onclick = ()=> { ul.style.display = (ul.style.display==='none'||ul.style.display==='') ? 'block' : 'none'; };
    div.appendChild(title); div.appendChild(ul); filmList.appendChild(div);
  });

  // search
  document.getElementById('search').addEventListener('input', (e)=>{
    const q = e.target.value.trim().toLowerCase();
    document.querySelectorAll('.film').forEach(div=>{
      const title = div.querySelector('.film-title').textContent.toLowerCase();
      const lis = Array.from(div.querySelectorAll('li')).map(li=>li.textContent.toLowerCase());
      const match = title.includes(q) || lis.some(t=>t.includes(q));
      div.style.display = match ? 'block' : 'none';
    });
  });

  // toggle button behavior
  const sidebar = document.getElementById('sidebar');
  const toggle = document.getElementById('toggle-btn');
  toggle.addEventListener('click', (e)=>{
    e.stopPropagation();
    const closed = sidebar.classList.toggle('closed');
    // move toggle position and arrow
    updateTogglePosition(closed);
    toggle.querySelector('span').textContent = closed ? 'â–¸' : 'â—‚';
    // invalidate map
    map.invalidateSize();
  });

}).catch(err=>{
  console.error('GeoJSON load error', err);
  alert('GeoJSON yÃ¼klenemedi. Konsolu kontrol et.');
});
</script>
</body>
</html>
