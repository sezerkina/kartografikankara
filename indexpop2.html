<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{
  height:100%;
  margin:0;
  font-family:'-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif', sans-serif !important;
  background:#f7f9fb;
  overflow:hidden;
}

#sidebar{
  position:absolute;
  left:0;top:0;
  width:340px;height:100%;
  background:#fff;
  border-right:1px solid #e6eef6;
  box-shadow:2px 0 6px rgba(0,0,0,0.06);
  padding:18px;
  box-sizing:border-box;
  overflow:auto;
  transition:transform .35s ease;
  z-index:1200;
}
#sidebar.closed{transform:translateX(-100%);}
#toggle-btn{
  position:absolute;
  top:20px;left:340px;
  width:28px;height:48px;
  background:#fff;border:1px solid #d0d7df;border-left:none;
  border-radius:0 6px 6px 0;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;z-index:2000;
  box-shadow:0 1px 3px rgba(0,0,0,0.15);
  transition:background 0.2s ease, left .35s ease;
}
#toggle-btn:hover{background:#f3f4f6;}
#toggle-btn span{font-size:14pt;color:#0f172a;user-select:none;}
#sidebar h1{font-weight:700;font-size:12pt;margin:4px 0 8px;}
#sidebar .description{font-weight:400;font-style:italic;font-size:8pt;color:#445;line-height:1.2;margin-bottom:12px;}
#search{width:100%;padding:6px 8px;font-size:8pt;font-style:italic;border:1px solid #d0d7df;border-radius:6px;margin-bottom:12px;box-sizing:border-box;}
.film{margin-bottom:10px;border-bottom:1px solid #f0f4f8;padding-bottom:8px;}
.film-title{cursor:pointer;font-weight:500;font-size:11pt;color:#0f172a;margin-bottom:6px;}
.mekan-list{list-style:disc;margin:0 0 0 18px;padding:0;display:none;}
.mekan-list li{font-weight:400;font-size:9pt;margin-bottom:6px;cursor:pointer;color:#0f172a;}
.mekan-list li:hover{text-decoration:underline;}
#map{position:absolute;left:0;top:0;right:0;bottom:0;z-index:1;}
.leaflet-control-zoom{position:absolute !important;bottom:20px;right:20px;}
.leaflet-popup-content img {
  max-width: 100%;
  height: auto;
  border-radius: 6px;
  margin: 6px auto 0 auto; /* gÃ¶rseli yatayda ortalar */
  display: block;
}
.leaflet-popup-content { font-family: '-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif', sans-serif !important; font-weight: 400; }

/* Popup geniÅŸliÄŸi sabitleme */
.leaflet-popup-content-wrapper {
  width: 280px !important;
  max-width: 280px !important;
  min-width: 280px !important;
  box-sizing: border-box;
}
.leaflet-popup-content {
  overflow-wrap: break-word;
  text-align: left;
}

.leaflet-popup-content-wrapper,
.leaflet-popup-content,
.leaflet-popup-tip,
.leaflet-container,
.leaflet-popup {
  font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
  -webkit-font-smoothing: antialiased !important;
  -moz-osx-font-smoothing: grayscale !important;
}
</style>
</head>

<body>
<aside id="sidebar">
  <h1>Ankara SinemasÄ± HaritasÄ±: Filmler ve MekÃ¢nlar ðŸŽ¬</h1>
  <div class="description">
    Bu Ã§alÄ±ÅŸma Ankara Ãœniversitesi Sosyal Bilimler EnstitÃ¼sÃ¼ Radyo Televizyon ve Sinema Anabilim DalÄ±'nda 
    Prof. Dr. S. Ruken Ã–ztÃ¼rk danÄ±ÅŸmanlÄ±ÄŸÄ±nda Sezer Ahmet KÄ±na tarafÄ±ndan yÃ¼rÃ¼tÃ¼len 
    <i>"Sinemada Kentin DÃ¶nÃ¼ÅŸÃ¼mÃ¼nÃ¼ Seyretmek: Ankara Ã–rneÄŸi"</i> baÅŸlÄ±klÄ± doktora tezi kapsamÄ±nda hazÄ±rlanmÄ±ÅŸtÄ±r.
  </div>
  <input id="search" placeholder="Haritada ara" aria-label="Haritada ara">
  <div id="film-list"></div>
</aside>
<div id="toggle-btn"><span>â—‚</span></div>
<div id="map"></div>

<script>
function cleanFolderName(folder){
  if(!folder) return "";
  return folder.replace(/[\/|]+/g, '').trim();
}

const map = L.map('map', {zoomControl:true}).setView([39.93,32.85],11);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap contributors, &copy; Carto',
  maxZoom: 22
}).addTo(map);
map.zoomControl.setPosition('bottomright');

let films = {};
let featureToLayer = new Map();
let allLayers = L.layerGroup().addTo(map);

fetch('kmzs.geojson')
.then(r=>r.json())
.then(data=>{
  data.features.forEach(f=>{
    const folder = cleanFolderName(f.properties?.folder);
    const film = folder || "Bilinmeyen Film";
    const name = f.properties?.name || "(AdsÄ±z MekÃ¢n)";
    if(!films[film]) films[film]=[];
    films[film].push(f);

    const geom = f.geometry;
    if(!geom) return;

    let layer = null;
    if(geom.type === 'Point'){
      const coords = [geom.coordinates[1], geom.coordinates[0]];
      const color = '#2563eb';
      layer = L.circleMarker(coords, {radius:6, color, fillColor:color, fillOpacity:1});
    }

    if(layer){
      const props = f.properties || {};
      let desc = props.description || '';
      const imgMatches = desc.match(/<img[^>]*>/gi) || [];
      desc = desc.replace(/<img[^>]*>/gi, '').trim();
      if(props.image){ imgMatches.push(`<img src="${props.image}" alt="">`); }

      let popup = `<div style="font-family:-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important;">`;
      popup += `<div style="font-weight:700;font-size:11pt;margin-bottom:4px;">${name}</div>`;
      popup += `<div style="font-weight:500;font-size:10pt;margin-bottom:6px;">${folder}</div>`;
      if(desc){ popup += `<div style="font-weight:400;font-size:9pt;margin-bottom:8px;">${desc}</div>`; }
      if(imgMatches.length){ popup += imgMatches.join(''); }
      popup += `</div>`;

      layer.bindPopup(popup);
      layer.feature = f;
      allLayers.addLayer(layer);
      featureToLayer.set(f, layer);
    }
  });

  try{
    const b=allLayers.getBounds();
    if(b && b.isValid && b.isValid()) map.fitBounds(b.pad(0.08));
  }catch(e){ map.setView([39.93,32.85],11); }

  const filmList = document.getElementById('film-list');
  Object.keys(films).sort().forEach(film=>{
    const div=document.createElement('div');
    div.className='film';
    const title=document.createElement('div');
    title.className='film-title';
    title.textContent=film;
    const ul=document.createElement('ul');
    ul.className='mekan-list';

    films[film].forEach(feat=>{
      const li=document.createElement('li');
      li.textContent=feat.properties.name||'(AdsÄ±z Mekan)';
      li.onclick=(e)=>{
        e.stopPropagation();
        const layer=featureToLayer.get(feat);
        if(!layer) return;
        const g=feat.geometry;
        if(g.type==='Point'){ map.setView([g.coordinates[1],g.coordinates[0]],16); }
        layer.openPopup();
      };
      ul.appendChild(li);
    });

    title.onclick=()=>{
      ul.style.display=(ul.style.display==='none'||ul.style.display==='')?'block':'none';
    };
    div.appendChild(title);
    div.appendChild(ul);
    filmList.appendChild(div);
  });

  document.getElementById('search').addEventListener('input',(e)=>{
    const q=e.target.value.trim().toLowerCase();
    document.querySelectorAll('.film').forEach(div=>{
      const title=div.querySelector('.film-title').textContent.toLowerCase();
      const lis=Array.from(div.querySelectorAll('li')).map(li=>li.textContent.toLowerCase());
      const match=title.includes(q)||lis.some(t=>t.includes(q));
      div.style.display=match?'block':'none';
    });
  });

  const sidebar=document.getElementById('sidebar');
  const toggle=document.getElementById('toggle-btn');
  const arrow=toggle.querySelector('span');
  toggle.addEventListener('click',()=>{
    sidebar.classList.toggle('closed');
    if(sidebar.classList.contains('closed')){
      toggle.style.left='0';
      arrow.textContent='â–¸';
    } else {
      toggle.style.left='340px';
      arrow.textContent='â—‚';
    }
    map.invalidateSize();
  });
})
.catch(err=>{
  console.error('GeoJSON load error', err);
  alert('GeoJSON yÃ¼klenemedi. Konsolu kontrol et.');
});
</script>
</body>
</html>